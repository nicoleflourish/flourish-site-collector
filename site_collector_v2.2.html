<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flourish Site Collector v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .project-card {
            border-left: 4px solid #10b981;
            transition: all 0.2s;
        }
        .project-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .pricing-breakdown {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        .photo-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-4xl mx-auto p-4 pb-24">
        
        <!-- Header -->
        <div class="bg-green-600 text-white p-6 rounded-lg mb-6 shadow-lg">
            <h1 class="text-2xl font-bold mb-2">Flourish Site Collector v2.2</h1>
            <p class="text-sm opacity-90" id="headerSubtitle">Property Information</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent"></div>

        <!-- Fixed Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-50">
            <div class="max-w-4xl mx-auto flex gap-2">
                <button id="backBtn" onclick="navigateBack()" 
                    class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium disabled:opacity-30">
                    Back
                </button>
                <button id="actionBtn" 
                    class="flex-2 bg-green-600 text-white py-3 px-6 rounded-lg font-medium">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CALCULATOR LOGIC (Embedded)
        // ============================================
        
        const LABOR_RATES = {
            bed_prep_per_sqft: 3.00,
            path_paver_per_sqft: 4.00,
            path_flagstone_per_sqft: 6.00,
            sod_per_sqft: 1.75,
            mulch_only_per_sqft: 1.00,
            plant_labor_multiplier: 0.50,
            boulder_per_ton: 150,
            wall_per_linear_ft: 25,
            cleanup_base: 100,
            hauling_standard: 200
        };

        const FABRIC_PER_SQFT = 0.67;

        function calculateMaterials(project) {
            let total = 0;
            const materials = {};

            // Edging
            if (project.edging_length_ft > 0 && project.edging_type) {
                const edging = MATERIALS.edging.find(e => e.id === project.edging_type);
                if (edging) {
                    const sections = Math.ceil(project.edging_length_ft / edging.length);
                    const cost = sections * edging.price;
                    materials.edging = { sections, unit_price: edging.price, cost };
                    total += cost;
                }
            }

            // Fabric
            if (project.needs_fabric && project.area_sqft > 0) {
                const cost = project.area_sqft * FABRIC_PER_SQFT;
                materials.fabric = { sqft: project.area_sqft, cost };
                total += cost;
            }

            // Mulch
            if (project.mulch_cuyd > 0 && project.mulch_price > 0) {
                const cost = project.mulch_cuyd * project.mulch_price;
                materials.mulch = { cuyd: project.mulch_cuyd, price_per_cuyd: project.mulch_price, cost };
                total += cost;
            }

            // Plants
            if (project.plants && project.plants.length > 0) {
                const cost = project.plants.reduce((sum, p) => sum + (p.quantity * p.unit_price), 0);
                materials.plants = cost;
                total += cost;
            }

            // Path materials
            if (project.has_path && project.path_type === 'paver_gravel') {
                const stones = Math.floor(project.path_length_ft / 2);
                const stoneCost = stones * 14;
                materials.stepping_stones = { count: stones, cost: stoneCost };
                total += stoneCost;

                const area = project.path_length_ft * project.path_width_ft;
                const cuyd = Math.ceil((area * 0.25 / 27) * 2) / 2;
                const gravelCost = cuyd * (project.path_material_price || 50);
                materials.gravel = { cuyd, cost: gravelCost };
                total += gravelCost;

                const fabricCost = area * FABRIC_PER_SQFT;
                materials.path_fabric = fabricCost;
                total += fabricCost;
            }

            materials.total = total;
            return materials;
        }

        function calculateLabor(project) {
            let total = 0;

            // Bed prep
            if (project.needs_bed_prep && project.area_sqft > 0) {
                total += project.area_sqft * LABOR_RATES.bed_prep_per_sqft;
            }

            // Mulch application (if no bed prep)
            if (!project.needs_bed_prep && project.mulch_cuyd > 0) {
                total += project.area_sqft * LABOR_RATES.mulch_only_per_sqft;
            }

            // Plant installation
            if (project.plants && project.plants.length > 0) {
                const plantCost = project.plants.reduce((sum, p) => sum + (p.quantity * p.unit_price), 0);
                total += plantCost * LABOR_RATES.plant_labor_multiplier;
            }

            // Path labor
            if (project.has_path) {
                const area = project.path_length_ft * project.path_width_ft;
                total += area * LABOR_RATES.path_paver_per_sqft;
            }

            // Hauling
            if (project.needs_hauling) {
                total += LABOR_RATES.hauling_standard;
            }

            return total;
        }

        function calculateProposal(projects, markup = 0.15, designFee = 200) {
            const projectResults = projects.map(p => {
                const materials = calculateMaterials(p);
                const calculatedLabor = calculateLabor(p);
                
                const actualLabor = p.labor_override !== null && p.labor_override !== undefined 
                    ? p.labor_override 
                    : calculatedLabor;
                
                return {
                    name: p.name,
                    materials_cost: materials.total,
                    labor_cost_calculated: calculatedLabor,
                    labor_cost_actual: actualLabor,
                    labor_override: p.labor_override !== null && p.labor_override !== undefined,
                    labor_notes: p.labor_notes || '',
                    subtotal: materials.total + actualLabor,
                    details: { materials, calculatedLabor, actualLabor }
                };
            });

            const totalMaterials = projectResults.reduce((sum, p) => sum + p.materials_cost, 0);
            const totalLabor = projectResults.reduce((sum, p) => sum + p.labor_cost_actual, 0) + LABOR_RATES.cleanup_base;
            const subtotal = totalMaterials + totalLabor;
            const markupAmount = subtotal * markup;
            const total = subtotal + markupAmount + designFee;

            return {
                projects: projectResults,
                total_materials: totalMaterials,
                total_labor: totalLabor,
                cleanup_fee: LABOR_RATES.cleanup_base,
                subtotal,
                markup_percent: markup * 100,
                markup_amount: markupAmount,
                design_fee: designFee,
                total
            };
        }

        // ============================================
        // DATA MODEL
        // ============================================
        
        class PropertyData {
            constructor() {
                this.property = {
                    clientName: '',
                    address: '',
                    visitDate: new Date().toISOString().split('T')[0],
                    phone: '',
                    email: '',
                    photos: []  // Property-level photos
                };
                this.projects = [];
            }

            addProject(project) {
                this.projects.push(project);
                this.save();
            }

            updateProject(index, project) {
                this.projects[index] = project;
                this.save();
            }

            removeProject(index) {
                this.projects.splice(index, 1);
                this.save();
            }

            save() {
                localStorage.setItem('flourish_property_data', JSON.stringify(this));
            }

            static load() {
                const saved = localStorage.getItem('flourish_property_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    const property = new PropertyData();
                    Object.assign(property, data);
                    return property;
                }
                return new PropertyData();
            }

            toCalculatorJSON() {
                return {
                    client_name: this.property.clientName,
                    address: this.property.address,
                    phone: this.property.phone,
                    email: this.property.email,
                    visit_date: this.property.visitDate,
                    property_photos: this.property.photos,
                    projects: this.projects.map(p => p.toJSON()),
                    metadata: {
                        collected_by: 'Site Collector v2.2',
                        timestamp: new Date().toISOString()
                    }
                };
            }
        }

        class Project {
            constructor() {
                this.name = '';
                this.area_sqft = 0;
                this.edging_type = '';
                this.edging_length_ft = 0;
                this.mulch_type = '';
                this.mulch_depth_inches = 0;
                this.mulch_price = 0;
                this.mulch_cuyd = 0;
                this.needs_bed_prep = true;
                this.needs_fabric = true;
                this.needs_hauling = false;
                this.plants = [];
                this.labor_override = null;
                this.labor_notes = '';
                this.has_path = false;
                this.path_type = '';
                this.path_length_ft = 0;
                this.path_width_ft = 3.0;
                this.path_material = '';
                this.path_material_price = 0;
                this.photos = [];  // Project-level photos
            }

            toJSON() {
                return {
                    name: this.name,
                    area_sqft: this.area_sqft,
                    edging_type: this.edging_type,
                    edging_length_ft: this.edging_length_ft,
                    mulch_depth_inches: this.mulch_depth_inches,
                    mulch_cuyd: this.mulch_cuyd,
                    mulch_price: this.mulch_price,
                    needs_bed_prep: this.needs_bed_prep,
                    needs_fabric: this.needs_fabric,
                    needs_hauling: this.needs_hauling,
                    plants: this.plants,
                    labor_override: this.labor_override,
                    labor_notes: this.labor_notes,
                    path: this.has_path ? {
                        length_ft: this.path_length_ft,
                        width_ft: this.path_width_ft,
                        area_sqft: this.path_length_ft * this.path_width_ft,
                        path_type: this.path_type,
                        material: this.path_material,
                        price: this.path_material_price
                    } : null,
                    photos: this.photos
                };
            }
        }

        // ============================================
        // MATERIAL CATALOGS
        // ============================================
        
        const MATERIALS = {
            edging: [
                { id: 'steel_black', name: 'Steel Black (10 ft)', price: 19.99, length: 10 },
                { id: 'steel_green', name: 'Steel Green (10 ft)', price: 19.99, length: 10 },
                { id: 'benda_black_4', name: 'Benda Board Black 4" (20 ft)', price: 33, length: 20 },
                { id: 'benda_black_6', name: 'Benda Board Black 6" (20 ft)', price: 68, length: 20 },
                { id: 'benda_brown_4', name: 'Benda Board Brown 4" (20 ft)', price: 33, length: 20 }
            ],
            mulch: [
                { id: 'black_pine', name: 'Black Pine Mulch', price: 47 },
                { id: 'black_hardwood', name: 'Black Hardwood', price: 46 },
                { id: 'premium_hardwood', name: 'Premium Hardwood', price: 39 },
                { id: 'cedar', name: 'Cedar Mulch', price: 38 },
                { id: 'red_pine', name: 'Red Pine Mulch', price: 38 },
                { id: 'red_dyed', name: 'Red Dyed Mulch', price: 36 },
                { id: 'pine_deco', name: 'Pine Deco Mulch', price: 34 },
                { id: 'humus_compost', name: 'Humus Compost', price: 32 }
            ],
            flagstone: [
                { id: 'arizona_select', name: 'Arizona Select (1"-1.75")', price: 440, coverage: 90 },
                { id: 'tennessee_gray', name: 'Tennessee Gray Select (1"-1.5")', price: 450, coverage: 100 },
                { id: 'colorado_red', name: 'Colorado Red Patio', price: 420, coverage: 90 },
                { id: 'oklahoma_brown', name: 'Oklahoma Brown/Blue Patio', price: 300, coverage: 100 }
            ],
            gravel: [
                { id: 'pea_gravel', name: 'Pea Gravel', price: 50 },
                { id: 'decomposed_granite', name: 'Decomposed Granite', price: 48 },
                { id: 'crushed_granite', name: 'Crushed Granite', price: 45 }
            ]
        };

        // ============================================
        // APP STATE
        // ============================================
        
        const state = {
            view: 'property_info',
            propertyData: PropertyData.load(),
            editingProjectIndex: null,
            currentProject: null,
            proposalResult: null
        };

        // ============================================
        // VIEW RENDERERS
        // ============================================

        function renderPropertyInfo() {
            const p = state.propertyData.property;
            return `
                <div class="bg-white rounded-lg shadow p-6 space-y-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Property Information</h2>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Name*</label>
                        <input type="text" id="clientName" value="${p.clientName}"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            placeholder="John & Sarah Smith">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property Address*</label>
                        <input type="text" id="address" value="${p.address}"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            placeholder="123 Oak Lane, Houston, TX 77005">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="phone" value="${p.phone}"
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="(713) 555-1234">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Visit Date</label>
                            <input type="date" id="visitDate" value="${p.visitDate}"
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" value="${p.email}"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            placeholder="client@email.com">
                    </div>

                    <!-- Property Photos -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property Photos (1-2 overall shots)</label>
                        <input type="file" id="propertyPhotos" accept="image/*" multiple capture="environment"
                            onchange="handlePropertyPhotos(event)"
                            class="w-full px-4 py-3 border rounded-lg">
                        ${p.photos && p.photos.length > 0 ? `
                            <div class="flex gap-2 mt-2 flex-wrap">
                                ${p.photos.map((photo, i) => `
                                    <div class="relative">
                                        <img src="${photo}" class="photo-preview rounded border">
                                        <button onclick="removePropertyPhoto(${i})" 
                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                                            √ó
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderProjectsList() {
            const projects = state.propertyData.projects;
            return `
                <div class="space-y-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">
                                Projects for ${state.propertyData.property.clientName || 'Property'}
                            </h2>
                            <button onclick="startOver()" class="text-sm text-red-600 hover:text-red-700">
                                üóëÔ∏è Start Over
                            </button>
                        </div>
                        
                        ${projects.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <p class="text-lg mb-2">No projects added yet</p>
                                <p class="text-sm">Click "Add Project" below to get started</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${projects.map((proj, i) => `
                                    <div class="project-card bg-gray-50 border-2 rounded-lg p-4">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800">${proj.name}</h3>
                                                <div class="text-sm text-gray-600 mt-2 space-y-1">
                                                    ${proj.area_sqft > 0 ? `<p>‚Ä¢ Area: ${proj.area_sqft} sq ft</p>` : ''}
                                                    ${proj.plants.length > 0 ? `<p>‚Ä¢ Plants: ${proj.plants.length} types, ${proj.plants.reduce((sum, p) => sum + p.quantity, 0)} total</p>` : ''}
                                                    ${proj.photos.length > 0 ? `<p>‚Ä¢ Photos: ${proj.photos.length}</p>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex gap-2 ml-4">
                                                <button onclick="editProject(${i})" 
                                                    class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                                    Edit
                                                </button>
                                                <button onclick="removeProject(${i})" 
                                                    class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}

                        <button onclick="addNewProject()" 
                            class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
                            + Add Project
                        </button>
                    </div>

                    ${projects.length > 0 ? `
                        <button onclick="calculateAndShowProposal()" 
                            class="w-full bg-blue-600 text-white py-4 rounded-lg font-medium text-lg hover:bg-blue-700">
                            üí∞ Calculate Proposal
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function renderProjectForm() {
            const p = state.currentProject;
            const isEditing = state.editingProjectIndex !== null;
            
            return `
                <div class="bg-white rounded-lg shadow p-6 space-y-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        ${isEditing ? 'Edit Project' : 'New Project'}
                    </h2>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Name*</label>
                        <input type="text" id="projectName" value="${p.name}"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            placeholder="e.g., Front Garden Bed">
                    </div>

                    <!-- PROJECT PHOTOS -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Photos (1-2 shots of this area)</label>
                        <input type="file" id="projectPhotos" accept="image/*" multiple capture="environment"
                            onchange="handleProjectPhotos(event)"
                            class="w-full px-4 py-3 border rounded-lg">
                        ${p.photos && p.photos.length > 0 ? `
                            <div class="flex gap-2 mt-2 flex-wrap">
                                ${p.photos.map((photo, i) => `
                                    <div class="relative">
                                        <img src="${photo}" class="photo-preview rounded border">
                                        <button onclick="removeProjectPhoto(${i})" 
                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                                            √ó
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- BED SPECIFICATIONS -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-800 mb-3">Bed Specifications</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bed Area (sq ft)</label>
                                <input type="number" id="bedArea" value="${p.area_sqft || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Edging Length (ft)</label>
                                <input type="number" id="edgingLength" value="${p.edging_length_ft || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="80">
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Edging Type</label>
                            <select id="edgingType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">None</option>
                                ${MATERIALS.edging.map(e => `
                                    <option value="${e.id}" ${p.edging_type === e.id ? 'selected' : ''}>
                                        ${e.name} - $${e.price}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- MULCH -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-800 mb-3">Mulch</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Depth (inches)</label>
                                <input type="number" id="mulchDepth" value="${p.mulch_depth_inches || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="3" step="0.25">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mulch Type</label>
                                <select id="mulchType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">None</option>
                                    ${MATERIALS.mulch.map(m => `
                                        <option value="${m.id}" data-price="${m.price}" ${p.mulch_type === m.id ? 'selected' : ''}>
                                            ${m.name} - $${m.price}/cuyd
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="mt-3 space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="needsBedPrep" ${p.needs_bed_prep ? 'checked' : ''}
                                    class="w-5 h-5 text-green-600">
                                <span class="text-sm">Needs bed prep ($3/sqft)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="needsFabric" ${p.needs_fabric ? 'checked' : ''}
                                    class="w-5 h-5 text-green-600">
                                <span class="text-sm">Install landscape fabric</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="needsHauling" ${p.needs_hauling ? 'checked' : ''}
                                    class="w-5 h-5 text-green-600">
                                <span class="text-sm">Needs hauling ($200)</span>
                            </label>
                        </div>
                    </div>

                    <!-- PLANTS -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-800 mb-3">Plants</h3>
                        <div id="plantsContainer" class="space-y-2">
                            ${p.plants.map((plant, i) => `
                                <div class="flex gap-2 items-center p-3 bg-gray-50 rounded border">
                                    <div class="flex-1 text-sm">
                                        <strong>${plant.name}</strong> (${plant.size}) - 
                                        ${plant.quantity} √ó $${plant.unit_price.toFixed(2)}
                                    </div>
                                    <button onclick="removePlantFromForm(${i})" 
                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                        Remove
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="showAddPlantDialog()" 
                            class="mt-2 w-full bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300">
                            + Add Plant
                        </button>
                    </div>

                    <!-- LABOR OVERRIDE -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-800 mb-3">Labor (Optional Override)</h3>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <p class="text-xs text-yellow-800">
                                <strong>Auto-calculated:</strong> Estimated based on area/materials. 
                                <strong>Override:</strong> Enter crew quote or adjusted amount below.
                            </p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Labor Override ($)</label>
                                <input type="number" id="laborOverride" value="${p.labor_override || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="Leave blank for auto" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Override Notes</label>
                                <input type="text" id="laborNotes" value="${p.labor_notes || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                    placeholder="e.g., Crew quote">
                            </div>
                        </div>
                    </div>

                    <!-- PATH -->
                    <div class="border-t pt-4">
                        <label class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="hasPath" ${p.has_path ? 'checked' : ''}
                                onchange="togglePathSection()"
                                class="w-5 h-5 text-green-600">
                            <span class="font-bold text-gray-800">This project includes a path</span>
                        </label>

                        <div id="pathSection" class="space-y-3 ${p.has_path ? '' : 'hidden'}">
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Length (ft)</label>
                                    <input type="number" id="pathLength" value="${p.path_length_ft || ''}"
                                        class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Width (ft)</label>
                                    <input type="number" id="pathWidth" value="${p.path_width_ft || 3.0}"
                                        class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500"
                                        step="0.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select id="pathType" onchange="updatePathMaterials()"
                                        class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                                        <option value="paver_gravel" ${p.path_type === 'paver_gravel' ? 'selected' : ''}>Paver + Gravel</option>
                                        <option value="flagstone" ${p.path_type === 'flagstone' ? 'selected' : ''}>Flagstone</option>
                                        <option value="dg" ${p.path_type === 'dg' ? 'selected' : ''}>Decomposed Granite</option>
                                    </select>
                                </div>
                            </div>

                            <div id="pathMaterialSelect">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                                <select id="pathMaterial" class="w-full px-3 py-2 border rounded">
                                    ${p.path_type === 'flagstone' ? 
                                        MATERIALS.flagstone.map(f => `
                                            <option value="${f.id}" data-price="${f.price}" ${p.path_material === f.id ? 'selected' : ''}>
                                                ${f.name} - $${f.price}/ton
                                            </option>
                                        `).join('') :
                                        MATERIALS.gravel.map(g => `
                                            <option value="${g.id}" data-price="${g.price}" ${p.path_material === g.id ? 'selected' : ''}>
                                                ${g.name} - $${g.price}/cuyd
                                            </option>
                                        `).join('')
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="flex gap-3 pt-4 border-t">
                        <button onclick="cancelProject()" 
                            class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300">
                            Cancel
                        </button>
                        <button onclick="saveProjectFromForm()" 
                            class="flex-2 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
                            ${isEditing ? 'Update Project' : 'Add Project'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProposal() {
            const result = state.proposalResult;
            const data = state.propertyData;
            
            return `
                <div class="space-y-4">
                    <div class="pricing-breakdown text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Proposal for ${data.property.clientName}</h2>
                        <div class="text-4xl font-bold mb-2">$${result.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <p class="text-blue-100">${data.property.address}</p>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Projects (${result.projects.length})</h3>
                        ${result.projects.map((proj, i) => `
                            <div class="border-b pb-4 mb-4 last:border-0">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-gray-700">${proj.name}</h4>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-green-600">$${proj.subtotal.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div class="flex justify-between">
                                        <span>Materials:</span>
                                        <span class="font-medium">$${proj.materials_cost.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Labor${proj.labor_override ? ' (OVERRIDE)' : ' (auto)'}:</span>
                                        <span class="font-medium">$${proj.labor_cost_actual.toFixed(2)}</span>
                                    </div>
                                    ${proj.labor_override ? `
                                        <div class="flex justify-between text-xs text-gray-500 italic pl-4">
                                            <span>Auto was:</span>
                                            <span>$${proj.labor_cost_calculated.toFixed(2)}</span>
                                        </div>
                                        ${proj.labor_notes ? `
                                            <div class="text-xs text-blue-600 pl-4 italic">
                                                ${proj.labor_notes}
                                            </div>
                                        ` : ''}
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Cost Summary</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Total Materials:</span>
                                <span class="font-medium">$${result.total_materials.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Labor:</span>
                                <span class="font-medium">$${result.total_labor.toFixed(2)}</span>
                            </div>
                            <div class="border-t pt-2 flex justify-between">
                                <span>Subtotal:</span>
                                <span class="font-medium">$${result.subtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Markup (${result.markup_percent}%):</span>
                                <span class="font-medium">$${result.markup_amount.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Design Fee:</span>
                                <span class="font-medium">$${result.design_fee.toFixed(2)}</span>
                            </div>
                            <div class="border-t-2 border-green-600 pt-2 flex justify-between text-lg font-bold text-green-600">
                                <span>TOTAL PRICE:</span>
                                <span>$${result.total.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="exportJSON()" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700">
                            üì• Export JSON
                        </button>
                        <button onclick="navigate('projects_list')" 
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300">
                            ‚Üê Back to Projects
                        </button>
                    </div>
                </div>
            `;
        }

        // ============================================
        // NAVIGATION
        // ============================================

        function navigate(view) {
            state.view = view;
            render();
        }

        function navigateBack() {
            if (state.view === 'projects_list') navigate('property_info');
            else if (state.view === 'project_form') navigate('projects_list');
            else if (state.view === 'proposal') navigate('projects_list');
        }

        function render() {
            const contentMap = {
                'property_info': renderPropertyInfo,
                'projects_list': renderProjectsList,
                'project_form': renderProjectForm,
                'proposal': renderProposal
            };

            document.getElementById('mainContent').innerHTML = contentMap[state.view]();
            
            const titles = {
                'property_info': 'Property Information',
                'projects_list': 'Projects',
                'project_form': state.editingProjectIndex !== null ? 'Edit Project' : 'New Project',
                'proposal': 'Proposal'
            };
            document.getElementById('headerSubtitle').textContent = titles[state.view];

            document.getElementById('backBtn').disabled = state.view === 'property_info';
            
            const actionBtn = document.getElementById('actionBtn');
            if (state.view === 'property_info') {
                actionBtn.textContent = 'Continue';
                actionBtn.onclick = savePropertyInfo;
                actionBtn.style.display = 'block';
            } else if (state.view === 'proposal') {
                actionBtn.style.display = 'none';
            } else {
                actionBtn.style.display = 'block';
                actionBtn.textContent = 'Back to Projects';
                actionBtn.onclick = () => navigate('projects_list');
            }
        }

        // ============================================
        // PROPERTY INFO
        // ============================================

        function savePropertyInfo() {
            state.propertyData.property.clientName = document.getElementById('clientName').value;
            state.propertyData.property.address = document.getElementById('address').value;
            state.propertyData.property.phone = document.getElementById('phone').value;
            state.propertyData.property.visitDate = document.getElementById('visitDate').value;
            state.propertyData.property.email = document.getElementById('email').value;
            
            if (!state.propertyData.property.clientName) {
                alert('Please enter client name');
                return;
            }
            
            state.propertyData.save();
            navigate('projects_list');
        }

        function handlePropertyPhotos(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.propertyData.property.photos.push(e.target.result);
                    state.propertyData.save();
                    render();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        }

        function removePropertyPhoto(index) {
            state.propertyData.property.photos.splice(index, 1);
            state.propertyData.save();
            render();
        }

        // ============================================
        // PROJECT MANAGEMENT
        // ============================================

        function addNewProject() {
            state.currentProject = new Project();
            state.editingProjectIndex = null;
            navigate('project_form');
        }

        function editProject(index) {
            const proj = state.propertyData.projects[index];
            state.currentProject = Object.assign(new Project(), proj);
            state.editingProjectIndex = index;
            navigate('project_form');
        }

        function removeProject(index) {
            if (confirm('Remove this project?')) {
                state.propertyData.removeProject(index);
                render();
            }
        }

        function saveProjectFromForm() {
            const p = state.currentProject;
            p.name = document.getElementById('projectName').value;
            p.area_sqft = parseFloat(document.getElementById('bedArea').value) || 0;
            p.edging_length_ft = parseFloat(document.getElementById('edgingLength').value) || 0;
            p.edging_type = document.getElementById('edgingType').value;
            
            const mulchDepth = parseFloat(document.getElementById('mulchDepth').value) || 0;
            p.mulch_depth_inches = mulchDepth;
            
            if (p.area_sqft > 0 && mulchDepth > 0) {
                p.mulch_cuyd = Math.ceil((p.area_sqft * (mulchDepth / 12) / 27) * 2) / 2;
            } else {
                p.mulch_cuyd = 0;
            }
            
            const mulchSelect = document.getElementById('mulchType');
            p.mulch_type = mulchSelect.value;
            p.mulch_price = parseFloat(mulchSelect.selectedOptions[0]?.dataset.price) || 0;
            
            p.needs_bed_prep = document.getElementById('needsBedPrep').checked;
            p.needs_fabric = document.getElementById('needsFabric').checked;
            p.needs_hauling = document.getElementById('needsHauling').checked;
            
            const laborOverride = document.getElementById('laborOverride').value;
            p.labor_override = laborOverride ? parseFloat(laborOverride) : null;
            p.labor_notes = document.getElementById('laborNotes').value;
            
            p.has_path = document.getElementById('hasPath').checked;
            if (p.has_path) {
                p.path_length_ft = parseFloat(document.getElementById('pathLength').value) || 0;
                p.path_width_ft = parseFloat(document.getElementById('pathWidth').value) || 3.0;
                p.path_type = document.getElementById('pathType').value;
                
                const pathMaterialSelect = document.getElementById('pathMaterial');
                if (pathMaterialSelect) {
                    p.path_material = pathMaterialSelect.value;
                    p.path_material_price = parseFloat(pathMaterialSelect.selectedOptions[0]?.dataset.price) || 0;
                }
            }
            
            if (!p.name) {
                alert('Please enter a project name');
                return;
            }
            
            if (state.editingProjectIndex !== null) {
                state.propertyData.updateProject(state.editingProjectIndex, p);
            } else {
                state.propertyData.addProject(p);
            }
            
            navigate('projects_list');
        }

        function cancelProject() {
            navigate('projects_list');
        }

        function handleProjectPhotos(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.currentProject.photos.push(e.target.result);
                    updateProjectPhotosDisplay();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        }

        function removeProjectPhoto(index) {
            state.currentProject.photos.splice(index, 1);
            updateProjectPhotosDisplay();
        }

        function updateProjectPhotosDisplay() {
            const container = document.getElementById('projectPhotos').parentElement;
            const photos = state.currentProject.photos;
            
            const existingDisplay = container.querySelector('.flex.gap-2');
            if (existingDisplay) existingDisplay.remove();
            
            if (photos.length > 0) {
                const div = document.createElement('div');
                div.className = 'flex gap-2 mt-2 flex-wrap';
                div.innerHTML = photos.map((photo, i) => `
                    <div class="relative">
                        <img src="${photo}" class="photo-preview rounded border">
                        <button onclick="removeProjectPhoto(${i})" 
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                            √ó
                        </button>
                    </div>
                `).join('');
                container.appendChild(div);
            }
        }

        // ============================================
        // PLANT MANAGEMENT
        // ============================================

        function showAddPlantDialog() {
            const name = prompt('Plant name:', 'Native Muhly Grass');
            if (!name) return;
            
            const size = prompt('Size:', '#1');
            if (!size) return;
            
            const quantity = parseInt(prompt('Quantity:', '10'));
            if (isNaN(quantity)) return;
            
            const price = parseFloat(prompt('Unit price ($):', '12.00'));
            if (isNaN(price)) return;
            
            state.currentProject.plants.push({ 
                name, 
                size, 
                quantity, 
                unit_price: price 
            });
            
            updatePlantsDisplay();
        }

        function removePlantFromForm(index) {
            state.currentProject.plants.splice(index, 1);
            updatePlantsDisplay();
        }

        function updatePlantsDisplay() {
            const container = document.getElementById('plantsContainer');
            const plants = state.currentProject.plants;
            
            container.innerHTML = plants.map((plant, i) => `
                <div class="flex gap-2 items-center p-3 bg-gray-50 rounded border">
                    <div class="flex-1 text-sm">
                        <strong>${plant.name}</strong> (${plant.size}) - 
                        ${plant.quantity} √ó $${plant.unit_price.toFixed(2)}
                    </div>
                    <button onclick="removePlantFromForm(${i})" 
                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                        Remove
                    </button>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No plants added yet</p>';
        }

        // ============================================
        // PATH MANAGEMENT
        // ============================================

        function togglePathSection() {
            const checked = document.getElementById('hasPath').checked;
            document.getElementById('pathSection').classList.toggle('hidden', !checked);
        }

        function updatePathMaterials() {
            const pathType = document.getElementById('pathType').value;
            const container = document.getElementById('pathMaterialSelect');
            
            if (pathType === 'flagstone') {
                container.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                    <select id="pathMaterial" class="w-full px-3 py-2 border rounded">
                        ${MATERIALS.flagstone.map(f => `
                            <option value="${f.id}" data-price="${f.price}">
                                ${f.name} - $${f.price}/ton
                            </option>
                        `).join('')}
                    </select>
                `;
            } else {
                container.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                    <select id="pathMaterial" class="w-full px-3 py-2 border rounded">
                        ${MATERIALS.gravel.map(g => `
                            <option value="${g.id}" data-price="${g.price}">
                                ${g.name} - $${g.price}/cuyd
                            </option>
                        `).join('')}
                    </select>
                `;
            }
        }

        // ============================================
        // PROPOSAL
        // ============================================

        function calculateAndShowProposal() {
            const projects = state.propertyData.projects.map(p => {
                const proj = new Project();
                Object.assign(proj, p);
                return proj;
            });
            
            state.proposalResult = calculateProposal(projects, 0.15, 200);
            navigate('proposal');
        }

        // ============================================
        // EXPORT
        // ============================================

        function exportJSON() {
            const json = state.propertyData.toCalculatorJSON();
            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `${json.client_name.replace(/\s+/g, '_')}_${json.visit_date}.json`;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function startOver() {
            if (confirm('‚ö†Ô∏è This will delete all data and start over. Are you sure?')) {
                localStorage.removeItem('flourish_property_data');
                state.propertyData = new PropertyData();
                navigate('property_info');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        if (state.propertyData.property.clientName) {
            state.view = 'projects_list';
        }

        render();
    </script>
</body>
</html>
